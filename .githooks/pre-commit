#!/bin/sh
# Pre-commit hook for code quality

echo "ğŸ” Running pre-commit checks..."

# Check if we're in the root directory
if [ ! -f "docker-compose.yml" ]; then
    echo "â„¹ï¸ Not in project root, skipping pre-commit checks"
    exit 0
fi

# Backend checks (only if Poetry is available)
if [ -d "backend" ]; then
    cd backend
    
    # Check if Poetry is available
    if command -v poetry >/dev/null 2>&1; then
        echo "ğŸ“ Formatting Python code..."
        poetry run black app/ --check >/dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "âš ï¸ Python code formatting issues detected."
            echo "ğŸ’¡ Run: cd backend && poetry run black app/"
            echo "ğŸ”„ Continuing with commit (will be fixed in CI)..."
        else
            echo "âœ… Python formatting: OK"
        fi
        
        echo "ğŸ” Checking Python linting..."
        poetry run flake8 app/ >/dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "âš ï¸ Python linting issues detected."
            echo "ğŸ’¡ Run: cd backend && poetry run flake8 app/"
            echo "ğŸ”„ Continuing with commit (will be checked in CI)..."
        else
            echo "âœ… Python linting: OK"
        fi
    else
        echo "â„¹ï¸ Poetry not found, skipping Python checks (will be validated in CI)"
    fi
    
    cd ..
fi

# Mobile checks (only if Flutter is available)
if [ -d "mobile" ]; then
    cd mobile
    
    # Check if Flutter is available
    if command -v flutter >/dev/null 2>&1; then
        echo "ğŸ“ Checking Dart formatting..."
        flutter format --output=none --set-exit-if-changed lib/ >/dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "âš ï¸ Dart formatting issues detected."
            echo "ğŸ’¡ Run: cd mobile && flutter format lib/"
            echo "ğŸ”„ Continuing with commit (will be fixed in CI)..."
        else
            echo "âœ… Dart formatting: OK"
        fi
        
        echo "ğŸ” Analyzing Dart code..."
        flutter analyze >/dev/null 2>&1
        if [ $? -ne 0 ]; then
            echo "âš ï¸ Dart analysis issues detected."
            echo "ğŸ’¡ Run: cd mobile && flutter analyze"
            echo "ğŸ”„ Continuing with commit (will be checked in CI)..."
        else
            echo "âœ… Dart analysis: OK"
        fi
    else
        echo "â„¹ï¸ Flutter not found, skipping mobile checks (will be validated in CI)"
    fi
    
    cd ..
fi

echo "âœ… Pre-commit checks completed! CI will perform comprehensive validation."
exit 0